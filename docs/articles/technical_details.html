<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technical details • greta</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Technical details">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">greta</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/get_started.html">get started</a>
</li>
<li>
  <a href="../articles/example_models.html">examples</a>
</li>
<li>
  <a href="../articles/faq.html">faq</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    functions
  </a>
</li>
<li>
  <a href="../articles/technical_details.html">
    <span class="fa fa-flask"></span>
     
    technical details
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    news
  </a>
</li>
<li>
  <a href="https://github.com/greta-dev/greta">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Technical details</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/greta-dev/greta/blob/master/vignettes/technical_details.Rmd"><code>vignettes/technical_details.Rmd</code></a></small>
      <div class="hidden name"><code>technical_details.Rmd</code></div>

    </div>

    
    
<p>This page provides technical implementation details for potential contributors or the curious. You don’t need to read this to be able to use greta.</p>
<div id="greta-arrays-nodes-and-tensors" class="section level2">
<h2 class="hasAnchor">
<a href="#greta-arrays-nodes-and-tensors" class="anchor"></a>greta arrays, nodes and tensors</h2>
<p>There are three layers to how greta defines a model: users manipulate <em>greta arrays</em>, these define <em>nodes</em>, and nodes then define <em>Tensors</em>.</p>
<div id="greta-arrays" class="section level3">
<h3 class="hasAnchor">
<a href="#greta-arrays" class="anchor"></a>greta arrays</h3>
<p>greta arrays are the user-facing representation of the model. greta arrays are actually just <code>lists</code>, but with the classes <code>greta_array</code> and <code>array</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/structures.html">ones</a></span>(<span class="dv">3</span>, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">is.list</span>(x)</a></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">class</span>(x)</a></code></pre></div>
<pre><code>[1] "greta_array" "array"      </code></pre>
</div>
<div id="nodes" class="section level3">
<h3 class="hasAnchor">
<a href="#nodes" class="anchor"></a>nodes</h3>
<p>The only list element of a greta array is <code>node</code>, an R6 object inheriting from the R6 class ‘node’, as well as one of the three node types: ‘data’, ‘operation’ or ‘variable’.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">class</span>(x<span class="op">$</span>node)</a></code></pre></div>
<pre><code>[1] "data_node" "node"      "R6"       </code></pre>
<p>There is a fourth node type: ‘distribution’, but these are never directly associated with greta arrays.</p>
<p>These R6 node objects are where the magic happens. When created, each node points to its ‘child’ nodes - the nodes for the greta arrays that were used to create this one.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># data nodes have no children</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">length</span>(x<span class="op">$</span>node<span class="op">$</span>children)</a></code></pre></div>
<pre><code>[1] 0</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># operation nodes have one or more children</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">z &lt;-<span class="st"> </span>x <span class="op">*</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">length</span>(z<span class="op">$</span>node<span class="op">$</span>children)</a></code></pre></div>
<pre><code>[1] 2</code></pre>
<p>Each node also has a list of its parents, the nodes that have been created from this one.</p>
<p>When <code>model()</code> is called, that inheritance information is used to construct the directed acyclic graph (DAG) that defines the model. The inheritance also preserves intermediate nodes, such as those creates in multi-part operations, but not assigned as greta arrays.</p>
<p>Nodes also have a value member, which is an array for data nodes or an ‘unknowns’ object for other node types. The unknowns class is a thin wrapper around arrays, which prints the question marks. Generic functions for working on arrays (e.g. <code>dim</code>, <code>length</code>, <code>print</code>) make use these node values to return something familiar to the user.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">x<span class="op">$</span>node<span class="op">$</span><span class="kw">value</span>()</a></code></pre></div>
<pre><code>     [,1] [,2] [,3]
[1,]    1    1    1
[2,]    1    1    1
[3,]    1    1    1</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># R calls this a matrix because it's 2d, but it's an array</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw">class</span>(x<span class="op">$</span>node<span class="op">$</span><span class="kw">value</span>())</a></code></pre></div>
<pre><code>[1] "matrix"</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">z<span class="op">$</span>node<span class="op">$</span><span class="kw">value</span>()</a></code></pre></div>
<pre><code>     [,1] [,2] [,3]
[1,]  ?    ?    ?  
[2,]  ?    ?    ?  
[3,]  ?    ?    ?  </code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">class</span>(z<span class="op">$</span>node<span class="op">$</span><span class="kw">value</span>())</a></code></pre></div>
<pre><code>[1] "unknowns" "matrix"  </code></pre>
</div>
<div id="tensors" class="section level3">
<h3 class="hasAnchor">
<a href="#tensors" class="anchor"></a>Tensors</h3>
<p>In addition to remembering their shape and size and where they are in the DAG, each node has methods to define a corresponding TensorFlow Tensor object in a specified environment. That doesn’t happen until the user runs <code>model()</code>, which creates a ‘dag_class’ object to store the relevant nodes, the environment for the tensors, and methods to talk to the TensorFlow graph.</p>
<p>The node <code>tf()</code> method takes the dag as an argument, and defines a tensor representing itself in the tensorflow environment, with a name determined by the dag object.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">x<span class="op">$</span>node<span class="op">$</span>tf</a></code></pre></div>
<pre><code>function (dag) {
      assign(dag$tf_name(self),
             tf$constant(self$value(), dtype = tf_float()),
             envir = dag$tf_environment)
    }
&lt;environment: 0x3aeb6c0&gt;</code></pre>
<p>Because R6 objects are pass-by-reference (rather than pass-by-value), the dag accumulates all of the defined tensors, rather than being re-written each time. Similarly, because nodes are R6 objects and know which are their children, they can make sure those children are defined as tensors before they are. The <code>define_tf()</code> member function ensures that that happens, enabling operation nodes to use the tensors for their children when defining their own tensor.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">z<span class="op">$</span>node<span class="op">$</span>tf</a></code></pre></div>
<pre><code>function (dag) {

      # fetch the tensors for the environment
      arg_tf_names &lt;- lapply(self$children, dag$tf_name)
      args &lt;- lapply(arg_tf_names, get, envir = dag$tf_environment)

      # fetch additional (non-tensor) arguments, if any
      if (length(self$operation_args) &gt; 0)
        args &lt;- c(args, self$operation_args)

      # apply function on tensors
      node &lt;- do.call(self$operation, args)

      # assign it in the environment
      assign(dag$tf_name(self), node, envir = dag$tf_environment)

    }
&lt;environment: 0x45a9098&gt;</code></pre>
</div>
</div>
<div id="variables-and-free-states" class="section level2">
<h2 class="hasAnchor">
<a href="#variables-and-free-states" class="anchor"></a>variables and free states</h2>
<p>Hamiltonian Monte Carlo (HMC) requires all of the parameters to be transformed to a continuous scale for sampling. Variable nodes are therefore converted to tensors by first defining a ‘free’ (unconstrained) version of themselves as a tensor, and then applying a transformation function to convert them back to the scale of interest.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">a &lt;-<span class="st"> </span><span class="kw"><a href="../reference/variable.html">variable</a></span>(<span class="dt">lower =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw">class</span>(a<span class="op">$</span>node)</a></code></pre></div>
<pre><code>[1] "variable_node" "node"          "R6"           </code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">a<span class="op">$</span>node<span class="op">$</span>tf_from_free</a></code></pre></div>
<pre><code>function (x, env) {

      upper &lt;- self$upper
      lower &lt;- self$lower

      if (self$constraint == 'none') {

        y &lt;- x

      } else if (self$constraint == 'both') {

        y &lt;- tf$nn$sigmoid(x) * fl(upper - lower) + fl(lower)

      } else if (self$constraint == 'low') {

        y &lt;- fl(upper) - tf$exp(x)

      } else if (self$constraint == 'high') {

        y &lt;- tf$exp(x) + fl(lower)

      } else {

        y &lt;- x

      }

      y

    }
&lt;environment: 0x48d4b28&gt;</code></pre>
</div>
<div id="distributions" class="section level2">
<h2 class="hasAnchor">
<a href="#distributions" class="anchor"></a>distributions</h2>
<p>distribution nodes are node objects just like the others, but they are not <em>directly</em> associated with greta arrays. Instead, greta arrays may have a distribution node in their <code>distribution</code> slot to indicate that their values are assumed to follow that distribution. The distribution node will also be listed as a parent node, and likewise the ‘target node’ will be listed as a child of the distribution. Distribution nodes also have child nodes (data, variables or operations) representing their parameters.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">normal</a></span>(<span class="dv">0</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="kw">class</span>(b<span class="op">$</span>node)</a></code></pre></div>
<pre><code>[1] "variable_node" "node"          "R6"           </code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw">class</span>(b<span class="op">$</span>node<span class="op">$</span>distribution)</a></code></pre></div>
<pre><code>[1] "normal_distribution" "distribution_node"   "node"               
[4] "R6"                 </code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co"># a is the target of its own distribution</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw">class</span>(b<span class="op">$</span>node<span class="op">$</span>distribution<span class="op">$</span>target)</a></code></pre></div>
<pre><code>[1] "variable_node" "node"          "R6"           </code></pre>
<p>When they define themselves as tensors, distribution nodes define the log density of their target node/tensor given the tensors representing their parameters.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">b<span class="op">$</span>node<span class="op">$</span>distribution<span class="op">$</span>tf_log_density</a></code></pre></div>
<pre><code>function (dag) {

      # fetch inputs
      tf_target_node &lt;- self$get_tf_target_node()
      tf_target &lt;- get(dag$tf_name(tf_target_node),
                       envir = dag$tf_environment)
      tf_parameters &lt;- self$tf_fetch_parameters(dag)

      # calculate log density
      ld &lt;- self$tf_log_density_function(tf_target, tf_parameters)

      # check for truncation
      if (!is.null(self$truncation))
        ld &lt;- ld - self$tf_log_density_offset(tf_parameters)

      ld
    }
&lt;environment: 0x46f1d40&gt;</code></pre>
<p>If the distribution was truncated, the log density is normalised using the cumulative distribution function.</p>
</div>
<div id="joint-density" class="section level2">
<h2 class="hasAnchor">
<a href="#joint-density" class="anchor"></a>Joint density</h2>
<p>Those log-densities for these distributions are summed on the TensorFlow graph to create a Tensor for the joint log-density of the model. TensorFlow’s automatic gradient capabilities are then used to define a Tensor for the gradient of the log-density with respect to each parameter in the model.</p>
<p>The <code>dag</code> R6 object contained within the model then exposes methods to send parameters to the TensorFlow graph and return the joint density and gradient.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">model &lt;-<span class="st"> </span><span class="kw">model</span>(b)</a>
<a class="sourceLine" id="cb35-2" data-line-number="2">model<span class="op">$</span>dag<span class="op">$</span>send_parameters</a></code></pre></div>
<pre><code>function (parameters, flat = TRUE) {

      # convert parameters to a named list and change TF names to free versions
      parameters &lt;- relist_tf(parameters, self$parameters_example)
      names(parameters) &lt;- paste0(names(parameters), '_free')

      # create a feed dict in the TF environment
      self$tf_environment$parameters &lt;- parameters
      self$tf_run(parameter_dict &lt;- do.call(dict, parameters))

    }
&lt;environment: 0x432dbc0&gt;</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">model<span class="op">$</span>dag<span class="op">$</span>log_density</a></code></pre></div>
<pre><code>function(adjusted = TRUE) {

      cleanly(self$tf_run(sess$run(joint_density_adj,
                                   feed_dict = parameter_dict)))

    }
&lt;environment: 0x432dbc0&gt;</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">model<span class="op">$</span>dag<span class="op">$</span>gradients</a></code></pre></div>
<pre><code>function (adjusted = TRUE) {

      cleanly(self$tf_run(sess$run(gradients_adj,
                                   feed_dict = parameter_dict)))

    }
&lt;environment: 0x432dbc0&gt;</code></pre>
<p>These methods are used by MCMC samplers to explore the model parameters.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#greta-arrays-nodes-and-tensors">greta arrays, nodes and tensors</a></li>
      <li><a href="#variables-and-free-states">variables and free states</a></li>
      <li><a href="#distributions">distributions</a></li>
      <li><a href="#joint-density">Joint density</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nick Golding.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
